<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¿ãƒ¬ãƒ³ãƒˆãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆæ¥­ç•Œ å¤‰åŒ–è¿½è·¡ã‚·ã‚¹ãƒ†ãƒ </title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8fafc;
        }
        
        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .main-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-top: 20px;
        }

        @media (max-width: 1200px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            .chatbot-sidebar {
                position: fixed;
                bottom: 20px;
                right: 20px;
                width: 350px;
                max-height: 500px;
                z-index: 1000;
            }
        }
        
        .header {
            background: white;
            padding: 30px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 28px;
            font-weight: 600;
            color: #1e293b;
            text-align: center;
        }
        
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .company-select {
            padding: 10px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            min-width: 200px;
        }
        
        .company-select:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        .update-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .update-btn:hover {
            background: #2563eb;
        }
        
        .update-btn:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        
        .stat-number {
            font-size: 32px;
            font-weight: 700;
            color: #3b82f6;
            display: block;
        }
        
        .stat-label {
            color: #64748b;
            font-size: 14px;
            margin-top: 5px;
        }
        
        .section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }
        
        .section h2 {
            font-size: 20px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .comparison-view {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .comparison-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 2px solid #e2e8f0;
            position: relative;
        }
        
        .comparison-card.current {
            border-color: #10b981;
        }
        
        .comparison-card.previous {
            border-color: #f59e0b;
        }
        
        .comparison-header {
            font-weight: 600;
            margin-bottom: 15px;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .comparison-header.current {
            background: #dcfce7;
            color: #166534;
        }
        
        .comparison-header.previous {
            background: #fef3c7;
            color: #92400e;
        }
        
        .comparison-content {
            space-y: 15px;
        }
        
        .comparison-item {
            margin-bottom: 15px;
        }
        
        .comparison-label {
            font-weight: 600;
            color: #64748b;
            font-size: 12px;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .comparison-text {
            background: #f8fafc;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
            word-break: break-word;
            min-height: 60px;
        }
        
        .companies-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }
        
        .company-card {
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
        }
        
        .company-card:hover {
            border-color: #3b82f6;
            background: #f0f9ff;
            transform: translateY(-2px);
        }
        
        .company-card.active {
            border-color: #3b82f6;
            background: #eff6ff;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.15);
        }
        
        .company-name {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 10px;
        }
        
        .company-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .change-count {
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .change-count.active {
            background: #dcfce7;
            color: #166534;
        }
        
        .change-count.inactive {
            background: #f1f5f9;
            color: #64748b;
        }
        
        .changes-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .change-item {
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            margin-bottom: 15px;
            background: #fafafa;
            border-left: 4px solid #3b82f6;
        }
        
        .change-header {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 10px;
        }
        
        .change-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            font-size: 14px;
        }
        
        .change-before,
        .change-after {
            padding: 10px;
            border-radius: 4px;
            background: white;
            border: 1px solid #e2e8f0;
        }
        
        .change-label {
            font-weight: 600;
            color: #64748b;
            margin-bottom: 5px;
            font-size: 12px;
            text-transform: uppercase;
        }
        
        .change-text {
            color: #374151;
            word-break: break-word;
        }
        
        .change-date {
            color: #64748b;
            font-size: 12px;
            text-align: right;
            margin-top: 10px;
        }
        
        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #fecaca;
            margin-bottom: 20px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }
        
        .loading::before {
            content: "â³";
            font-size: 24px;
            display: block;
            margin-bottom: 10px;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }
        
        .empty-state::before {
            content: "ğŸ“­";
            font-size: 48px;
            display: block;
            margin-bottom: 15px;
        }
        
        @media (max-width: 768px) {
            .change-details,
            .comparison-view {
                grid-template-columns: 1fr;
            }
            
            .companies-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .company-select {
                min-width: 100%;
            }
        }
        
        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #64748b;
            background: #f8fafc;
            border-radius: 8px;
            border: 2px dashed #cbd5e1;
        }
        
        .no-data h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }
        
        .no-data p {
            font-size: 14px;
        }
        /* ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚¹ã‚¿ã‚¤ãƒ« */
        .chatbot-sidebar {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 700px;
            position: sticky;
            top: 20px;
        }

        .chatbot-header {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            padding: 20px;
            font-weight: 600;
            font-size: 16px;
            text-align: center;
        }

        .chatbot-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chat-message {
            padding: 12px 16px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.5;
        }

        .chat-message.bot {
            background: #f0f9ff;
            color: #1e40af;
            align-self: flex-start;
            border: 1px solid #bfdbfe;
        }

        .chat-message.user {
            background: #3b82f6;
            color: white;
            align-self: flex-end;
        }

        .chatbot-input-area {
            padding: 20px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
        }

        .chatbot-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            resize: none;
            font-family: inherit;
        }

        .chatbot-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>ğŸš€ ã‚¿ãƒ¬ãƒ³ãƒˆãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆæ¥­ç•Œ å¤‰åŒ–è¿½è·¡ã‚·ã‚¹ãƒ†ãƒ </h1>
        </div>
    </div>

    <div class="container">
        <div class="main-layout">
            <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ -->
            <div>
                <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
                <div class="controls">
            <select id="companySelect" class="company-select">
                <option value="">ğŸ“Š ã™ã¹ã¦ã®ä¼æ¥­ã‚’è¡¨ç¤º</option>
            </select>
            <button id="updateBtn" class="update-btn" onclick="loadData()">
                ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
            </button>
        </div>
        
        <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
        <div id="errorContainer"></div>
        
        <!-- çµ±è¨ˆæƒ…å ± -->
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-number" id="totalCompanies">-</span>
                <div class="stat-label">ç›£è¦–å¯¾è±¡ä¼æ¥­</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="totalChanges">-</span>
                <div class="stat-label">ç·å¤‰æ›´æ•°</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="activeCompanies">-</span>
                <div class="stat-label">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ä¼æ¥­</div>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="lastUpdate">-</span>
                <div class="stat-label">æœ€çµ‚æ›´æ–°</div>
            </div>
        </div>

        <!-- æ¯”è¼ƒè¡¨ç¤º -->
        <div id="comparisonSection" class="section" style="display: none;">
            <h2 id="comparisonTitle">ğŸ” ã‚µã‚¤ãƒˆè¦‹ãˆæ–¹æ¯”è¼ƒ</h2>
            <div id="comparisonContent"></div>
        </div>

        <!-- ä¼æ¥­ä¸€è¦§ -->
        <div class="section" id="companiesSection">
            <h2>ğŸ“Š ç›£è¦–å¯¾è±¡ä¼æ¥­</h2>
            <div id="companiesContainer">
                <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
            </div>
        </div>

        <!-- å¤‰æ›´å±¥æ­´ -->
        <div class="section">
            <h2 id="changesTitle">ğŸ“‹ æœ€æ–°å¤‰æ›´å±¥æ­´</h2>
            <div id="changesContainer">
                <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
            </div>
        </div>

            </div> <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„çµ‚äº† -->

            <!-- ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
            <div class="chatbot-sidebar">
                <div class="chatbot-header">
                    ğŸ’¬ è³ªå•ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ
                </div>
                <div class="chatbot-messages" id="chatMessages">
                    <div class="chat-message bot" style="white-space: pre-wrap;">ã“ã‚“ã«ã¡ã¯ï¼ã‚¿ãƒ¬ãƒ³ãƒˆãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆæ¥­ç•Œã®å¤‰åŒ–è¿½è·¡ã‚·ã‚¹ãƒ†ãƒ ã«ã¤ã„ã¦ã€ãŠæ°—è»½ã«ã”è³ªå•ãã ã•ã„ã€‚

ğŸ“Š è³ªå•ä¾‹ï¼š
â€¢ ã€Œã‚«ã‚ªãƒŠãƒ“ã®æˆ¦ç•¥ã¯ï¼Ÿã€
â€¢ ã€Œãƒ‡ãƒ¼ã‚¿ã®ä¿¡é ¼æ€§ã¯ï¼Ÿã€
â€¢ ã€Œãªãœãã®åˆ†æçµæœã«ãªã£ãŸã®ã‹ï¼Ÿã€
â€¢ ã€Œç«¶åˆã¨ã®é•ã„ã¯ï¼Ÿã€

ğŸ’¡ ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã§ã¯ã€å®Ÿãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ãŸå›ç­”ã‚’æä¾›ã—ã€ãƒ‡ãƒ¼ã‚¿ã®å‡ºæ‰€ã¨æ ¹æ‹ ã‚’æ˜ç¤ºã—ã¾ã™ã€‚æƒ…å ±ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€Webæ¤œç´¢ãƒªãƒ³ã‚¯ã‚’æä¾›ã—ã¾ã™ã€‚</div>
                </div>
                <div class="chatbot-input-area">
                    <textarea id="chatInput" class="chatbot-input" rows="3" placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦Enterã‚­ãƒ¼ã‚’æŠ¼ã—ã¦ãã ã•ã„..." onkeypress="handleChatKeyPress(event)"></textarea>
                </div>
            </div>

            </div> <!-- main-layoutçµ‚äº† -->
    </div> <!-- containerçµ‚äº† -->

    <!-- ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ -->
    <script src="sample-data.js"></script>

    <script>
        let companies = [];
        let changes = [];
        let selectedCompany = null;

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        async function loadData() {
            const updateBtn = document.getElementById('updateBtn');
            updateBtn.textContent = 'â³ èª­ã¿è¾¼ã¿ä¸­...';
            updateBtn.disabled = true;
            
            clearError();
            
            try {
                // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼ˆJSONãƒ•ã‚¡ã‚¤ãƒ«ã®ä»£æ›¿ï¼‰
                companies = sampleCompanies;
                changes = sampleChanges;
                
                updateStats();
                renderCompanies();
                renderChanges();
                populateCompanySelect();
                
                updateBtn.textContent = 'âœ… æ›´æ–°å®Œäº†';
                setTimeout(() => {
                    updateBtn.textContent = 'ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°';
                    updateBtn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                showError(`ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ${error.message}`);
                updateBtn.textContent = 'âŒ æ›´æ–°å¤±æ•—';
                updateBtn.disabled = false;
            }
        }

        // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«ä¼æ¥­ãƒªã‚¹ãƒˆã‚’è¿½åŠ 
        function populateCompanySelect() {
            const select = document.getElementById('companySelect');
            
            // æ—¢å­˜ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢ï¼ˆæœ€åˆã®ã‚‚ã®ã¯æ®‹ã™ï¼‰
            while (select.children.length > 1) {
                select.removeChild(select.lastChild);
            }
            
            // ä¼æ¥­ã‚’è¿½åŠ 
            companies.forEach(company => {
                const option = document.createElement('option');
                option.value = company.id;
                option.textContent = `ğŸ¢ ${company.name}`;
                select.appendChild(option);
            });
            
            // å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            select.onchange = function() {
                const companyId = parseInt(this.value);
                if (companyId) {
                    selectCompanyById(companyId);
                } else {
                    resetSelection();
                }
            };
        }

        // IDã§ä¼æ¥­é¸æŠ
        function selectCompanyById(companyId) {
            selectedCompany = companies.find(c => c.id === companyId);
            if (selectedCompany) {
                renderCompanies();
                renderChanges();
                renderComparison();
                document.getElementById('changesTitle').textContent = `ğŸ“‹ ${selectedCompany.name} ã®å¤‰æ›´å±¥æ­´`;
            }
        }

        // çµ±è¨ˆæƒ…å ±æ›´æ–°
        function updateStats() {
            document.getElementById('totalCompanies').textContent = companies.length;
            document.getElementById('totalChanges').textContent = changes.length;
            
            // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ä¼æ¥­æ•°ï¼ˆå¤‰æ›´ãŒã‚ã£ãŸä¼æ¥­ï¼‰
            const activeCompanies = companies.filter(company => company.change_count > 0).length;
            document.getElementById('activeCompanies').textContent = activeCompanies;
            
            // æœ€çµ‚æ›´æ–°æ™‚åˆ»
            const now = new Date();
            document.getElementById('lastUpdate').textContent = now.toLocaleTimeString('ja-JP', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ä¼æ¥­ä¸€è¦§æç”»
        function renderCompanies() {
            const container = document.getElementById('companiesContainer');
            
            if (companies.length === 0) {
                container.innerHTML = '<div class="empty-state">ä¼æ¥­ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
                return;
            }
            
            container.innerHTML = `
                <div class="companies-grid">
                    ${companies.map(company => `
                        <div class="company-card ${selectedCompany?.id === company.id ? 'active' : ''}" 
                             onclick="selectCompany(${company.id})">
                            <div class="company-name">${escapeHtml(company.name)}</div>
                            <div class="company-stats">
                                <span class="change-count ${company.change_count > 0 ? 'active' : 'inactive'}">
                                    å¤‰æ›´: ${company.change_count}å›
                                </span>
                                <div style="font-size: 12px; color: #64748b;">
                                    ${company.last_checked ? formatDateTime(company.last_checked) : 'æœªç¢ºèª'}
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ä¼æ¥­é¸æŠ
        function selectCompany(companyId) {
            selectedCompany = companies.find(c => c.id === companyId);
            const select = document.getElementById('companySelect');
            select.value = companyId;
            
            renderCompanies();
            renderChanges();
            renderComparison();
            
            document.getElementById('changesTitle').textContent = `ğŸ“‹ ${selectedCompany.name} ã®å¤‰æ›´å±¥æ­´`;
        }

        // é¸æŠãƒªã‚»ãƒƒãƒˆ
        function resetSelection() {
            selectedCompany = null;
            const select = document.getElementById('companySelect');
            select.value = '';
            
            renderCompanies();
            renderChanges();
            hideComparison();
            
            document.getElementById('changesTitle').textContent = 'ğŸ“‹ æœ€æ–°å¤‰æ›´å±¥æ­´';
        }

        // æ¯”è¼ƒè¡¨ç¤º
        function renderComparison() {
            if (!selectedCompany) {
                hideComparison();
                return;
            }

            const section = document.getElementById('comparisonSection');
            const content = document.getElementById('comparisonContent');
            const title = document.getElementById('comparisonTitle');

            // å°‚é–€ç”¨èªã‚¬ã‚¤ãƒ‰ã®å ´åˆ
            if (selectedCompany.isGuide) {
                title.textContent = `ğŸ“– å°‚é–€ç”¨èªã‚¬ã‚¤ãƒ‰`;
                content.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: #f8fafc; border-radius: 8px;">
                        <h3 style="margin-bottom: 15px; color: #1e293b;">ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã§ä½¿ç”¨ã™ã‚‹å°‚é–€ç”¨èªã®èª¬æ˜</h3>
                        <img src="${selectedCompany.guideImage}" alt="å°‚é–€ç”¨èªã‚¬ã‚¤ãƒ‰" style="max-width: 100%; height: auto; border: 2px solid #e2e8f0; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                    </div>
                `;
                section.style.display = 'block';
                return;
            }

            title.textContent = `ğŸ” ${selectedCompany.name} ã®ã‚µã‚¤ãƒˆè¦‹ãˆæ–¹æ¯”è¼ƒ`;

            // å¤‰æ›´ç®‡æ‰€ã®ãƒãƒƒã‚¸ç”Ÿæˆ
            const changesHtml = selectedCompany.changes ? selectedCompany.changes.map(change => {
                const badgeColor = change.type === 'HP' ? '#10b981' :
                                 change.type === 'SEO' ? '#f59e0b' :
                                 change.type === 'AD' ? '#8b5cf6' : '#6b7280';
                const badgeIcon = change.type === 'HP' ? 'ğŸ ' :
                                change.type === 'SEO' ? 'ğŸ”' :
                                change.type === 'AD' ? 'ğŸ“º' : 'ğŸ“';

                return `
                    <span class="change-badge" style="background: ${badgeColor}; color: white; padding: 4px 8px; border-radius: 12px; font-size: 11px; margin-right: 6px; display: inline-block; margin-bottom: 4px;">
                        ${badgeIcon} ${change.category}
                    </span>
                `;
            }).join('') : '';

            content.innerHTML = `
                <!-- ã‚µã‚¤ãƒˆURL -->
                <div style="margin-bottom: 20px; text-align: center;">
                    <a href="${selectedCompany.url}" target="_blank" class="site-link" style="
                        display: inline-block;
                        background: #3b82f6;
                        color: white;
                        text-decoration: none;
                        padding: 10px 20px;
                        border-radius: 6px;
                        font-weight: 600;
                        transition: all 0.3s ease;
                    " onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                        ğŸŒ ${selectedCompany.name} ã®ã‚µã‚¤ãƒˆã‚’è¦‹ã‚‹
                    </a>
                </div>

                <!-- è¨¼æ‹ ãƒ»ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ -->
                ${selectedCompany.evidenceSources ? `
                    <div style="margin-bottom: 20px; padding: 15px; background: #ecfdf5; border-radius: 8px; border: 1px solid #10b981;">
                        <h4 style="margin-bottom: 10px; color: #047857; font-weight: 600;">ğŸ” ãƒ‡ãƒ¼ã‚¿ã®ä¿¡é ¼æ€§</h4>
                        <div style="background: white; padding: 12px; border-radius: 6px; margin-bottom: 10px;">
                            <div style="font-size: 12px; color: #059669; line-height: 1.8;">
                                <div style="margin-bottom: 8px;">
                                    <strong>ğŸ“… ãƒ‡ãƒ¼ã‚¿å–å¾—æ—¥æ™‚:</strong> ${escapeHtml(selectedCompany.evidenceSources.retrievalDate)}
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <strong>ğŸŒ å–å¾—å…ƒURL:</strong>
                                    <a href="${escapeHtml(selectedCompany.evidenceSources.sourceUrl)}" target="_blank"
                                       style="color: #059669; text-decoration: underline;">
                                        ${escapeHtml(selectedCompany.evidenceSources.sourceUrl)}
                                    </a>
                                </div>
                                <div style="margin-bottom: 8px;">
                                    <strong>âš™ï¸ å–å¾—æ–¹æ³•:</strong> ${escapeHtml(selectedCompany.evidenceSources.verificationMethod)}
                                </div>
                            </div>
                        </div>
                        <div style="background: white; padding: 12px; border-radius: 6px;">
                            <div style="font-weight: 600; color: #047857; margin-bottom: 8px; font-size: 13px;">âœ… ç¢ºèªæ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ãƒã‚¤ãƒ³ãƒˆ</div>
                            <ul style="margin: 0; padding-left: 20px; color: #065f46; font-size: 12px; line-height: 1.8;">
                                ${selectedCompany.evidenceSources.dataPoints.map(point =>
                                    `<li>${escapeHtml(point)}</li>`
                                ).join('')}
                            </ul>
                        </div>
                    </div>
                ` : ''}

                <!-- å¤‰æ›´ã‚«ãƒ†ã‚´ãƒª -->
                ${changesHtml ? `
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8fafc; border-radius: 8px; border: 1px solid #e2e8f0;">
                        <h4 style="margin-bottom: 10px; color: #1e293b; font-weight: 600;">ğŸ“Š å¤‰æ›´ã‚«ãƒ†ã‚´ãƒª</h4>
                        ${changesHtml}
                    </div>
                ` : ''}

                <!-- è©³ç´°ãªå¤‰æ›´å±¥æ­´ -->
                ${selectedCompany.changes && selectedCompany.changes.length > 0 ? `
                    <div style="margin-top: 20px; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 1px solid #bfdbfe;">
                        <h4 style="margin-bottom: 15px; color: #1e40af; font-weight: 600;">ğŸ“‹ å¤‰æ›´è©³ç´°</h4>
                        ${selectedCompany.changes.map((change, changeIndex) => {
                            const borderColor = change.type === 'HP' ? '#10b981' :
                                              change.type === 'SEO' ? '#f59e0b' :
                                              change.type === 'AD' ? '#8b5cf6' : '#6b7280';
                            const icon = change.type === 'HP' ? 'ğŸ ' :
                                       change.type === 'SEO' ? 'ğŸ”' :
                                       change.type === 'AD' ? 'ğŸ“º' : 'ğŸ“';

                            return `
                                <div style="margin-bottom: 15px; background: white; border-radius: 6px; border-left: 4px solid ${borderColor}; overflow: hidden;">
                                    <div style="padding: 15px; cursor: pointer; background: #fafafa;" onclick="toggleDetail(${changeIndex})">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <div style="font-weight: 600; color: #374151; margin-bottom: 5px;">
                                                    ${icon} ${change.category} (${change.date})
                                                </div>
                                                <div style="color: #6b7280; font-size: 14px;">${escapeHtml(change.description)}</div>
                                            </div>
                                            <div id="toggle-icon-${changeIndex}" style="font-size: 20px; color: #64748b;">â–¼</div>
                                        </div>
                                    </div>

                                    ${change.detailedAnalysis ? `
                                        <div id="detail-${changeIndex}" style="display: none; padding: 15px; border-top: 1px solid #e2e8f0;">
                                            <div style="background: #fffbeb; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #f59e0b;">
                                                <div style="font-weight: 700; color: #92400e; margin-bottom: 10px; font-size: 15px;">ğŸ¯ å¤‰æ›´ã‚¿ã‚¤ãƒ—</div>
                                                <div style="color: #78350f; font-size: 14px;">${escapeHtml(change.detailedAnalysis.changeType)}</div>
                                            </div>

                                            <div style="background: #f0fdf4; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #10b981;">
                                                <div style="font-weight: 700; color: #166534; margin-bottom: 10px; font-size: 15px;">ğŸ“ å…·ä½“çš„ãªå¤‰æ›´å†…å®¹</div>
                                                <ul style="margin: 0; padding-left: 20px; color: #14532d;">
                                                    ${change.detailedAnalysis.whatChanged.map(item =>
                                                        `<li style="margin-bottom: 6px; font-size: 13px;">${escapeHtml(item)}</li>`
                                                    ).join('')}
                                                </ul>
                                            </div>

                                            ${change.detailedAnalysis.seoStrategy ? `
                                                <div style="background: #fef3c7; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #f59e0b;">
                                                    <div style="font-weight: 700; color: #92400e; margin-bottom: 10px; font-size: 15px;">ğŸ” SEOæˆ¦ç•¥è©³ç´°</div>

                                                    <div style="margin-bottom: 12px;">
                                                        <div style="font-weight: 600; color: #78350f; margin-bottom: 5px; font-size: 13px;">ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</div>
                                                        <ul style="margin: 0; padding-left: 20px; color: #78350f;">
                                                            ${change.detailedAnalysis.seoStrategy.targetKeywords.map(kw =>
                                                                `<li style="margin-bottom: 4px; font-size: 12px;">${escapeHtml(kw)}</li>`
                                                            ).join('')}
                                                        </ul>
                                                    </div>

                                                    <div style="margin-bottom: 12px;">
                                                        <div style="font-weight: 600; color: #78350f; margin-bottom: 5px; font-size: 13px;">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰é…ç½®æˆ¦ç•¥</div>
                                                        <div style="font-size: 12px; color: #78350f; line-height: 1.6;">
                                                            â€¢ Title: ${escapeHtml(change.detailedAnalysis.seoStrategy.keywordPlacement.titleTag)}<br>
                                                            â€¢ Meta Description: ${escapeHtml(change.detailedAnalysis.seoStrategy.keywordPlacement.metaDescription)}<br>
                                                            â€¢ H1: ${escapeHtml(change.detailedAnalysis.seoStrategy.keywordPlacement.h1Tag)}<br>
                                                            â€¢ Body: ${escapeHtml(change.detailedAnalysis.seoStrategy.keywordPlacement.bodyContent)}
                                                        </div>
                                                    </div>

                                                    <div style="background: white; padding: 10px; border-radius: 4px;">
                                                        <div style="font-weight: 600; color: #92400e; margin-bottom: 5px; font-size: 13px;">æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ</div>
                                                        <div style="font-size: 12px; color: #78350f;">${escapeHtml(change.detailedAnalysis.seoStrategy.expectedImpact)}</div>
                                                    </div>

                                                    ${change.detailedAnalysis.technicalDetails ? `
                                                        <div style="margin-top: 10px; background: white; padding: 10px; border-radius: 4px;">
                                                            <div style="font-weight: 600; color: #92400e; margin-bottom: 5px; font-size: 13px;">æŠ€è¡“çš„æ–½ç­–</div>
                                                            <div style="font-size: 12px; color: #78350f; line-height: 1.6;">
                                                                â€¢ æ§‹é€ åŒ–ãƒ‡ãƒ¼ã‚¿: ${escapeHtml(change.detailedAnalysis.technicalDetails.structuredData)}<br>
                                                                â€¢ ãƒšãƒ¼ã‚¸é€Ÿåº¦: ${escapeHtml(change.detailedAnalysis.technicalDetails.pageSpeed)}<br>
                                                                â€¢ ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–: ${escapeHtml(change.detailedAnalysis.technicalDetails.mobileOptimization)}
                                                            </div>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            ` : ''}

                                            ${change.detailedAnalysis.adPlatforms ? `
                                                <div style="background: #f5f3ff; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #8b5cf6;">
                                                    <div style="font-weight: 700; color: #5b21b6; margin-bottom: 10px; font-size: 15px;">ğŸ“º åºƒå‘Šãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ åˆ¥æˆ¦ç•¥</div>

                                                    ${change.detailedAnalysis.adPlatforms.googleSearch ? `
                                                        <div style="background: white; padding: 12px; border-radius: 4px; margin-bottom: 10px;">
                                                            <div style="font-weight: 600; color: #5b21b6; margin-bottom: 8px; font-size: 13px;">ğŸ” Googleæ¤œç´¢åºƒå‘Š</div>
                                                            <div style="font-size: 12px; color: #6b21a8; line-height: 1.6;">
                                                                â€¢ äºˆç®—: ${escapeHtml(change.detailedAnalysis.adPlatforms.googleSearch.budget)}<br>
                                                                â€¢ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆKW: ${change.detailedAnalysis.adPlatforms.googleSearch.targetKeywords.join(', ')}<br>
                                                                â€¢ åºƒå‘Šæ–‡: ${escapeHtml(change.detailedAnalysis.adPlatforms.googleSearch.adCopy)}<br>
                                                                â€¢ CTRç›®æ¨™: ${escapeHtml(change.detailedAnalysis.adPlatforms.googleSearch.ctr)}
                                                            </div>
                                                        </div>
                                                    ` : ''}

                                                    ${change.detailedAnalysis.adPlatforms.googleDisplay ? `
                                                        <div style="background: white; padding: 12px; border-radius: 4px; margin-bottom: 10px;">
                                                            <div style="font-weight: 600; color: #5b21b6; margin-bottom: 8px; font-size: 13px;">ğŸ¨ Googleãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤åºƒå‘Š</div>
                                                            <div style="font-size: 12px; color: #6b21a8; line-height: 1.6;">
                                                                â€¢ äºˆç®—: ${escapeHtml(change.detailedAnalysis.adPlatforms.googleDisplay.budget)}<br>
                                                                â€¢ ã‚¿ãƒ¼ã‚²ãƒ†ã‚£ãƒ³ã‚°: ${escapeHtml(change.detailedAnalysis.adPlatforms.googleDisplay.targeting)}<br>
                                                                â€¢ ã‚¯ãƒªã‚¨ã‚¤ãƒ†ã‚£ãƒ–: ${escapeHtml(change.detailedAnalysis.adPlatforms.googleDisplay.creative)}
                                                            </div>
                                                        </div>
                                                    ` : ''}

                                                    ${change.detailedAnalysis.adPlatforms.youtube ? `
                                                        <div style="background: white; padding: 12px; border-radius: 4px;">
                                                            <div style="font-weight: 600; color: #5b21b6; margin-bottom: 8px; font-size: 13px;">â–¶ï¸ YouTubeåºƒå‘Š</div>
                                                            <div style="font-size: 12px; color: #6b21a8; line-height: 1.6;">
                                                                â€¢ äºˆç®—: ${escapeHtml(change.detailedAnalysis.adPlatforms.youtube.budget)}<br>
                                                                â€¢ å‹•ç”»å°º: ${escapeHtml(change.detailedAnalysis.adPlatforms.youtube.videoLength)}<br>
                                                                â€¢ è¨´æ±‚å†…å®¹: ${escapeHtml(change.detailedAnalysis.adPlatforms.youtube.message)}
                                                            </div>
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            ` : ''}

                                            <div style="background: #ecfdf5; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #10b981;">
                                                <div style="font-weight: 700; color: #047857; margin-bottom: 10px; font-size: 15px;">ğŸ’¼ ãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ</div>
                                                <div style="color: #065f46; font-size: 13px; line-height: 1.7;">${escapeHtml(change.detailedAnalysis.businessImpact)}</div>
                                            </div>

                                            ${change.detailedAnalysis.targetAudience ? `
                                                <div style="background: #eff6ff; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #3b82f6;">
                                                    <div style="font-weight: 700; color: #1e40af; margin-bottom: 10px; font-size: 15px;">ğŸ¯ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå±¤</div>
                                                    <div style="color: #1e3a8a; font-size: 13px;">${escapeHtml(change.detailedAnalysis.targetAudience)}</div>
                                                </div>
                                            ` : ''}

                                            ${change.detailedAnalysis.reasoning ? `
                                                <div style="background: #fefce8; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #eab308;">
                                                    <div style="font-weight: 700; color: #a16207; margin-bottom: 10px; font-size: 15px;">ğŸ§  è€ƒå¯Ÿã®æ ¹æ‹ </div>
                                                    ${Object.entries(change.detailedAnalysis.reasoning).map(([key, value]) => `
                                                        <div style="margin-bottom: 12px; background: white; padding: 10px; border-radius: 4px;">
                                                            <div style="font-weight: 600; color: #854d0e; margin-bottom: 5px; font-size: 12px; text-transform: uppercase;">
                                                                ${key === 'marketPosition' ? 'ğŸ“Š å¸‚å ´ãƒã‚¸ã‚·ãƒ§ãƒ³åˆ†æ' :
                                                                  key === 'messagingStrategy' ? 'ğŸ’¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°æˆ¦ç•¥' :
                                                                  key === 'targetInsight' ? 'ğŸ¯ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ´å¯Ÿ' :
                                                                  key === 'competitiveAnalysis' ? 'âš”ï¸ ç«¶åˆæ¯”è¼ƒ' : key}
                                                            </div>
                                                            <div style="color: #78350f; font-size: 12px; line-height: 1.7;">${escapeHtml(value)}</div>
                                                        </div>
                                                    `).join('')}
                                                </div>
                                            ` : ''}

                                            <div style="background: #fef2f2; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 3px solid #ef4444;">
                                                <div style="font-weight: 700; color: #dc2626; margin-bottom: 10px; font-size: 15px;">âš”ï¸ ç«¶åˆçŠ¶æ³åˆ†æ</div>
                                                <div style="color: #991b1b; font-size: 13px; line-height: 1.7;">${escapeHtml(change.detailedAnalysis.competitiveContext)}</div>
                                            </div>

                                            ${change.detailedAnalysis.estimatedBudget ? `
                                                <div style="background: #faf5ff; padding: 15px; border-radius: 6px; border-left: 3px solid #a855f7;">
                                                    <div style="font-weight: 700; color: #7e22ce; margin-bottom: 10px; font-size: 15px;">ğŸ’° æ¨å®šæŠ•è³‡é¡</div>
                                                    <div style="color: #6b21a8; font-size: 13px;">${escapeHtml(change.detailedAnalysis.estimatedBudget)}</div>
                                                </div>
                                            ` : ''}

                                            ${change.detailedAnalysis.roi ? `
                                                <div style="background: #faf5ff; padding: 15px; border-radius: 6px; margin-top: 10px; border-left: 3px solid #a855f7;">
                                                    <div style="font-weight: 700; color: #7e22ce; margin-bottom: 10px; font-size: 15px;">ğŸ“Š ROIç›®æ¨™</div>
                                                    <div style="color: #6b21a8; font-size: 13px;">${escapeHtml(change.detailedAnalysis.roi)}</div>
                                                </div>
                                            ` : ''}

                                            ${change.detailedAnalysis.metrics ? `
                                                <div style="background: #f0fdfa; padding: 15px; border-radius: 6px; margin-top: 10px; border-left: 3px solid #14b8a6;">
                                                    <div style="font-weight: 700; color: #0f766e; margin-bottom: 10px; font-size: 15px;">ğŸ“ˆ å®šé‡æŒ‡æ¨™</div>
                                                    <div style="font-size: 12px; color: #115e59; line-height: 1.6;">
                                                        ${Object.entries(change.detailedAnalysis.metrics).map(([key, value]) =>
                                                            `â€¢ ${key}: ${escapeHtml(value)}`
                                                        ).join('<br>')}
                                                    </div>
                                                </div>
                                            ` : ''}

                                            ${change.detailedAnalysis.testingStrategy ? `
                                                <div style="background: #fff7ed; padding: 15px; border-radius: 6px; margin-top: 10px; border-left: 3px solid #f97316;">
                                                    <div style="font-weight: 700; color: #c2410c; margin-bottom: 10px; font-size: 15px;">ğŸ§ª ãƒ†ã‚¹ãƒˆæˆ¦ç•¥</div>
                                                    <div style="color: #9a3412; font-size: 13px;">${escapeHtml(change.detailedAnalysis.testingStrategy)}</div>
                                                </div>
                                            ` : ''}
                                        </div>
                                    ` : `
                                        <div style="padding: 20px; background: #f8fafc; border-radius: 6px; text-align: center;">
                                            <div style="font-size: 40px; margin-bottom: 10px;">ğŸ“Š</div>
                                            <div style="font-weight: 600; color: #475569; margin-bottom: 10px; font-size: 14px;">è©³ç´°åˆ†æãƒ‡ãƒ¼ã‚¿åé›†ä¸­</div>
                                            <div style="color: #64748b; font-size: 12px; line-height: 1.6; max-width: 500px; margin: 0 auto;">
                                                ã“ã®ä¼æ¥­ã®è©³ç´°ãªãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥åˆ†æã¯ç¾åœ¨åé›†ä¸­ã§ã™ã€‚<br>
                                                å¤‰æ›´æ¤œçŸ¥å¾Œã€å°‚é–€ã‚¢ãƒŠãƒªã‚¹ãƒˆã«ã‚ˆã‚‹è©³ç´°åˆ†æã‚’é †æ¬¡è¿½åŠ ã—ã¦ã„ã¾ã™ã€‚<br>
                                                <span style="color: #3b82f6; font-weight: 600;">è¿‘æ—¥å…¬é–‹äºˆå®š</span>
                                            </div>
                                        </div>
                                    `
                                    }
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : ''}

                <!-- ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›´æ¯”è¼ƒ -->
                ${(selectedCompany.current_title || selectedCompany.previous_title ||
                   selectedCompany.current_description || selectedCompany.previous_description ||
                   selectedCompany.current_content || selectedCompany.previous_content) ? `
                    <div style="margin-top: 30px;">
                        <h3 style="margin-bottom: 15px; color: #1e293b; font-weight: 600;">ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆå¤‰æ›´æ¯”è¼ƒ</h3>
                        <div class="comparison-view">
                            <div class="comparison-card current">
                                <div class="comparison-header current">å¤‰æ›´å¾Œã®ãƒ†ã‚­ã‚¹ãƒˆ</div>
                                <div class="comparison-content">
                                    ${selectedCompany.current_title ? `
                                        <div class="comparison-item">
                                            <div class="comparison-label">ã‚¿ã‚¤ãƒˆãƒ«</div>
                                            <div class="comparison-text">${escapeHtml(selectedCompany.current_title)}</div>
                                        </div>
                                    ` : ''}
                                    ${selectedCompany.current_description ? `
                                        <div class="comparison-item">
                                            <div class="comparison-label">èª¬æ˜æ–‡</div>
                                            <div class="comparison-text">${escapeHtml(selectedCompany.current_description)}</div>
                                        </div>
                                    ` : ''}
                                    ${selectedCompany.current_content ? `
                                        <div class="comparison-item">
                                            <div class="comparison-label">ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</div>
                                            <div class="comparison-text">${escapeHtml(selectedCompany.current_content)}</div>
                                        </div>
                                    ` : ''}
                                    ${!selectedCompany.current_title && !selectedCompany.current_description && !selectedCompany.current_content ? `
                                        <div style="text-align: center; padding: 20px; color: #64748b;">
                                            å¤‰æ›´å¾Œã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
                                        </div>
                                    ` : ''}
                                </div>
                            </div>

                            <div class="comparison-card previous">
                                <div class="comparison-header previous">å¤‰æ›´å‰ã®ãƒ†ã‚­ã‚¹ãƒˆ</div>
                                <div class="comparison-content">
                                    ${selectedCompany.previous_title ? `
                                        <div class="comparison-item">
                                            <div class="comparison-label">ã‚¿ã‚¤ãƒˆãƒ«</div>
                                            <div class="comparison-text">${escapeHtml(selectedCompany.previous_title)}</div>
                                        </div>
                                    ` : ''}
                                    ${selectedCompany.previous_description ? `
                                        <div class="comparison-item">
                                            <div class="comparison-label">èª¬æ˜æ–‡</div>
                                            <div class="comparison-text">${escapeHtml(selectedCompany.previous_description)}</div>
                                        </div>
                                    ` : ''}
                                    ${selectedCompany.previous_content ? `
                                        <div class="comparison-item">
                                            <div class="comparison-label">ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„</div>
                                            <div class="comparison-text">${escapeHtml(selectedCompany.previous_content)}</div>
                                        </div>
                                    ` : ''}
                                    ${!selectedCompany.previous_title && !selectedCompany.previous_description && !selectedCompany.previous_content ? `
                                        <div style="text-align: center; padding: 20px; color: #64748b;">
                                            å¤‰æ›´å‰ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                ` : ''}
            `;

            section.style.display = 'block';
        }

        // æ¯”è¼ƒè¡¨ç¤ºã‚’éš ã™
        function hideComparison() {
            document.getElementById('comparisonSection').style.display = 'none';
        }

        // å¤‰æ›´å±¥æ­´æç”»
        function renderChanges() {
            const container = document.getElementById('changesContainer');
            
            // ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            let filteredChanges = changes;
            if (selectedCompany) {
                filteredChanges = changes.filter(change => change.company_id === selectedCompany.id);
            }
            
            if (filteredChanges.length === 0) {
                const message = selectedCompany 
                    ? `${selectedCompany.name}ã®å¤‰æ›´å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“`
                    : 'å¤‰æ›´å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“';
                container.innerHTML = `<div class="empty-state">${message}<br><small>å®šæœŸç›£è¦–ã§ãƒ‡ãƒ¼ã‚¿ãŒè“„ç©ã•ã‚Œã¾ã™</small></div>`;
                return;
            }
            
            container.innerHTML = `
                <div class="changes-list">
                    ${filteredChanges.slice(0, 20).map(change => `
                        <div class="change-item">
                            <div class="change-header">
                                ${escapeHtml(change.company_name)} - ${getChangeTypeLabel(change.change_type)}
                            </div>
                            <div class="change-details">
                                <div class="change-before">
                                    <div class="change-label">å¤‰æ›´å‰</div>
                                    <div class="change-text">${truncateText(change.old_value, 150)}</div>
                                </div>
                                <div class="change-after">
                                    <div class="change-label">å¤‰æ›´å¾Œ</div>
                                    <div class="change-text">${truncateText(change.new_value, 150)}</div>
                                </div>
                            </div>
                            <div class="change-date">${formatDateTime(change.detected_at)}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function escapeHtml(unsafe) {
            if (!unsafe) return '';
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function truncateText(text, maxLength) {
            if (!text) return '-';
            text = escapeHtml(text);
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'ä¸æ˜';
            try {
                return new Date(dateString).toLocaleString('ja-JP');
            } catch {
                return dateString;
            }
        }

        function getChangeTypeLabel(type) {
            const labels = {
                'title_change': 'ã‚¿ã‚¤ãƒˆãƒ«å¤‰æ›´',
                'description_change': 'ãƒ‡ã‚£ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³å¤‰æ›´',
                'content_change': 'ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¤‰æ›´'
            };
            return labels[type] || type;
        }

        function showError(message) {
            const container = document.getElementById('errorContainer');
            container.innerHTML = `<div class="error-message">${escapeHtml(message)}</div>`;
        }

        function clearError() {
            document.getElementById('errorContainer').innerHTML = '';
        }

        // è©³ç´°åˆ†æã®å±•é–‹ãƒ»æŠ˜ã‚ŠãŸãŸã¿
        function toggleDetail(index) {
            const detailEl = document.getElementById(`detail-${index}`);
            const iconEl = document.getElementById(`toggle-icon-${index}`);

            if (detailEl.style.display === 'none') {
                detailEl.style.display = 'block';
                iconEl.textContent = 'â–²';
            } else {
                detailEl.style.display = 'none';
                iconEl.textContent = 'â–¼';
            }
        }

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', loadData);

        // ãƒãƒ£ãƒƒãƒˆãƒœãƒƒãƒˆæ©Ÿèƒ½ - å®Ÿãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æ¤œç´¢ã—ã¦å›ç­”
        function searchInData(question) {
            const lowerQuestion = question.toLowerCase();
            let results = [];

            // ä¼æ¥­åã‚’æŠ½å‡º
            const companyNames = companies.map(c => c.name);
            const mentionedCompanies = companyNames.filter(name =>
                lowerQuestion.includes(name.toLowerCase().replace(/ğŸ“–|ã€|ã€‘/g, ''))
            );

            // ä¼æ¥­åˆ¥ã®æƒ…å ±ã‚’æ¤œç´¢
            companies.forEach(company => {
                if (company.isGuide) return; // ã‚¬ã‚¤ãƒ‰ã¯ã‚¹ã‚­ãƒƒãƒ—

                const companyName = company.name.toLowerCase();
                const isRelevant = lowerQuestion.includes(companyName) || mentionedCompanies.length === 0;

                if (isRelevant) {
                    // ã‚¿ã‚¤ãƒˆãƒ«ãƒ»èª¬æ˜æ–‡ã®æ¤œç´¢
                    if (company.current_title && (lowerQuestion.includes('ã‚¿ã‚¤ãƒˆãƒ«') || lowerQuestion.includes('title'))) {
                        results.push({
                            type: 'ç¾åœ¨ã®ã‚¿ã‚¤ãƒˆãƒ«',
                            company: company.name,
                            content: company.current_title
                        });
                    }

                    if (company.current_description && (lowerQuestion.includes('èª¬æ˜') || lowerQuestion.includes('description'))) {
                        results.push({
                            type: 'ç¾åœ¨ã®èª¬æ˜æ–‡',
                            company: company.name,
                            content: company.current_description
                        });
                    }

                    // è¨¼æ‹ ãƒ‡ãƒ¼ã‚¿ã®æ¤œç´¢
                    if (company.evidenceSources && (lowerQuestion.includes('è¨¼æ‹ ') || lowerQuestion.includes('ãƒ‡ãƒ¼ã‚¿') || lowerQuestion.includes('ä¿¡é ¼') || lowerQuestion.includes('å‡ºæ‰€') || lowerQuestion.includes('ã‚½ãƒ¼ã‚¹'))) {
                        results.push({
                            type: 'ãƒ‡ãƒ¼ã‚¿ã®ä¿¡é ¼æ€§',
                            company: company.name,
                            content: `å–å¾—æ—¥æ™‚: ${company.evidenceSources.retrievalDate}\nå–å¾—å…ƒ: ${company.evidenceSources.sourceUrl}\nå–å¾—æ–¹æ³•: ${company.evidenceSources.verificationMethod}\n\nç¢ºèªæ¸ˆã¿ãƒ‡ãƒ¼ã‚¿:\n${company.evidenceSources.dataPoints.map(p => `â€¢ ${p}`).join('\n')}`
                        });
                    }

                    // ã€Œãªãœã€ã“ã®æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã®ã‹
                    if (lowerQuestion.includes('ãªãœè¡¨ç¤º') || lowerQuestion.includes('ãªãœå‡º') || lowerQuestion.includes('ã©ã†ã—ã¦')) {
                        if (company.evidenceSources) {
                            results.push({
                                type: 'ãƒ‡ãƒ¼ã‚¿è¡¨ç¤ºã®ç†ç”±',
                                company: company.name,
                                content: `ã“ã®ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ç†ç”±ï¼š\n\n1. å®Ÿãƒ‡ãƒ¼ã‚¿ã®å–å¾—\n${company.evidenceSources.retrievalDate}ã«${company.evidenceSources.sourceUrl}ã‹ã‚‰å®Ÿéš›ã®ã‚µã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¾ã—ãŸã€‚\n\n2. æ¤œè¨¼æ–¹æ³•\n${company.evidenceSources.verificationMethod}ã«ã‚ˆã‚Šã€ãƒ‡ãƒ¼ã‚¿ã®æ­£ç¢ºæ€§ã‚’ç¢ºèªã—ã¦ã„ã¾ã™ã€‚\n\n3. è¡¨ç¤ºç›®çš„\nã‚¿ãƒ¬ãƒ³ãƒˆãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆæ¥­ç•Œã®å¤‰åŒ–ã‚’è¿½è·¡ã—ã€å„ç¤¾ã®ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥ã®å¤‰é·ã‚’å¯è¦–åŒ–ã™ã‚‹ãŸã‚ã«è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚`
                            });
                        }
                    }

                    // å¤‰æ›´è©³ç´°ã®æ¤œç´¢
                    if (company.changes && company.changes.length > 0) {
                        company.changes.forEach(change => {
                            if (!change.detailedAnalysis) return;

                            const analysis = change.detailedAnalysis;

                            // æˆ¦ç•¥ãƒ»ãƒã‚¸ã‚·ãƒ§ãƒ‹ãƒ³ã‚°
                            if (lowerQuestion.includes('æˆ¦ç•¥') || lowerQuestion.includes('ãƒã‚¸ã‚·ãƒ§ãƒ³')) {
                                results.push({
                                    type: 'æˆ¦ç•¥åˆ†æ',
                                    company: company.name,
                                    category: change.category,
                                    content: `å¤‰æ›´ã‚¿ã‚¤ãƒ—: ${analysis.changeType}\n\nå…·ä½“çš„ãªå¤‰æ›´:\n${analysis.whatChanged.map(c => `â€¢ ${c}`).join('\n')}\n\nãƒ“ã‚¸ãƒã‚¹ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ:\n${analysis.businessImpact}`
                                });
                            }

                            // è€ƒå¯Ÿã®æ ¹æ‹ 
                            if (analysis.reasoning && (lowerQuestion.includes('æ ¹æ‹ ') || lowerQuestion.includes('ãªãœ') || lowerQuestion.includes('ç†ç”±') || lowerQuestion.includes('è¡¨ç¾'))) {
                                const reasoningText = Object.entries(analysis.reasoning).map(([key, value]) => {
                                    const label = key === 'marketPosition' ? 'å¸‚å ´ãƒã‚¸ã‚·ãƒ§ãƒ³åˆ†æ' :
                                                key === 'messagingStrategy' ? 'ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°æˆ¦ç•¥' :
                                                key === 'targetInsight' ? 'ã‚¿ãƒ¼ã‚²ãƒƒãƒˆæ´å¯Ÿ' :
                                                key === 'competitiveAnalysis' ? 'ç«¶åˆæ¯”è¼ƒ' : key;
                                    return `ã€${label}ã€‘\n${value}`;
                                }).join('\n\n');

                                results.push({
                                    type: 'è€ƒå¯Ÿã®æ ¹æ‹ ',
                                    company: company.name,
                                    category: change.category,
                                    content: reasoningText,
                                    explanation: 'â€» ã“ã®è€ƒå¯Ÿã¯ã€å®Ÿéš›ã®ã‚µã‚¤ãƒˆã‹ã‚‰å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ï¼ˆã‚¿ã‚¤ãƒˆãƒ«ã€èª¬æ˜æ–‡ã€ãƒ¡ã‚¤ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰ã‚’åˆ†æã—ã€ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°æˆ¦ç•¥ã®å°‚é–€çš„è¦–ç‚¹ã‹ã‚‰å°ãå‡ºã—ãŸã‚‚ã®ã§ã™ã€‚å®¢è¦³çš„ãªäº‹å®Ÿï¼ˆå®Ÿãƒ‡ãƒ¼ã‚¿ï¼‰ã¨å°‚é–€çš„ãªè§£é‡ˆã‚’çµ„ã¿åˆã‚ã›ã¦ã„ã¾ã™ã€‚'
                                });
                            }

                            // ç«¶åˆåˆ†æ
                            if (lowerQuestion.includes('ç«¶åˆ') || lowerQuestion.includes('æ¯”è¼ƒ') || lowerQuestion.includes('é•ã„')) {
                                results.push({
                                    type: 'ç«¶åˆçŠ¶æ³åˆ†æ',
                                    company: company.name,
                                    category: change.category,
                                    content: analysis.competitiveContext
                                });
                            }

                            // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå±¤
                            if (analysis.targetAudience && (lowerQuestion.includes('ã‚¿ãƒ¼ã‚²ãƒƒãƒˆ') || lowerQuestion.includes('å¯¾è±¡'))) {
                                results.push({
                                    type: 'ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå±¤',
                                    company: company.name,
                                    category: change.category,
                                    content: analysis.targetAudience
                                });
                            }

                            // SEOæˆ¦ç•¥
                            if (analysis.seoStrategy && (lowerQuestion.includes('seo') || lowerQuestion.includes('æ¤œç´¢') || lowerQuestion.includes('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰'))) {
                                const seo = analysis.seoStrategy;
                                results.push({
                                    type: 'SEOæˆ¦ç•¥',
                                    company: company.name,
                                    category: change.category,
                                    content: `ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:\n${seo.targetKeywords.map(k => `â€¢ ${k}`).join('\n')}\n\næœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ:\n${seo.expectedImpact}`
                                });
                            }
                        });
                    }
                }
            });

            return results;
        }

        async function performWebSearch(query) {
            // Webæ¤œç´¢ã®ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆå®Ÿéš›ã®WebSearch APIã¯ä½¿ç”¨ã§ããªã„ãŸã‚ã€èª¬æ˜ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿”ã™ï¼‰
            return `Webæ¤œç´¢ã‚’å®Ÿè¡Œã—ã¾ã—ãŸï¼ˆGoogle/Yahooï¼‰ï¼šã€Œ${query}ã€\n\nâ€» ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã¯é™çš„ã‚µã‚¤ãƒˆã®ãŸã‚ã€å®Ÿéš›ã®Webæ¤œç´¢APIã«ã¯æ¥ç¶šã—ã¦ã„ã¾ã›ã‚“ã€‚\nå®Ÿéš›ã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã«ã¯ã€ä»¥ä¸‹ã®ãƒªãƒ³ã‚¯ã‹ã‚‰æ¤œç´¢ã—ã¦ãã ã•ã„ï¼š\nâ€¢ Google: https://www.google.com/search?q=${encodeURIComponent(query)}\nâ€¢ Yahoo: https://search.yahoo.co.jp/search?p=${encodeURIComponent(query)}`;
        }

        function explainDataSource(result) {
            // ãƒ‡ãƒ¼ã‚¿ã®å‡ºæ‰€ã¨æ ¹æ‹ ã‚’èª¬æ˜
            let explanation = '';

            if (result.type === 'ãƒ‡ãƒ¼ã‚¿ã®ä¿¡é ¼æ€§') {
                explanation = '\n\nğŸ“Š ãƒ‡ãƒ¼ã‚¿ã®å‡ºæ‰€ï¼š\nã“ã®æƒ…å ±ã¯ã€WebFetch APIã‚’ä½¿ç”¨ã—ã¦å®Ÿéš›ã®ä¼æ¥­ã‚µã‚¤ãƒˆã‹ã‚‰å–å¾—ã—ãŸã‚‚ã®ã§ã™ã€‚å–å¾—æ—¥æ™‚ã¨URLãŒè¨˜éŒ²ã•ã‚Œã¦ãŠã‚Šã€ã„ã¤ã§ã‚‚å…ƒã®ã‚µã‚¤ãƒˆã§ç¢ºèªã§ãã¾ã™ã€‚';
            } else if (result.type === 'æˆ¦ç•¥åˆ†æ' || result.type === 'è€ƒå¯Ÿã®æ ¹æ‹ ') {
                explanation = '\n\nğŸ§  åˆ†æã®æ ¹æ‹ ï¼š\nã“ã®åˆ†æã¯ã€ä»¥ä¸‹ã®å®¢è¦³çš„ãªäº‹å®Ÿã«åŸºã¥ã„ã¦ã„ã¾ã™ï¼š\n1. å®Ÿéš›ã®ã‚µã‚¤ãƒˆã‹ã‚‰å–å¾—ã—ãŸã‚¿ã‚¤ãƒˆãƒ«ãƒ»èª¬æ˜æ–‡\n2. ç«¶åˆä»–ç¤¾ã¨ã®æ¯”è¼ƒï¼ˆåŒæ™‚æœŸã«å–å¾—ã—ãŸä»–ç¤¾ãƒ‡ãƒ¼ã‚¿ï¼‰\n3. ãƒãƒ¼ã‚±ãƒ†ã‚£ãƒ³ã‚°ç†è«–ã«åŸºã¥ãè§£é‡ˆ\n\nâ€» è€ƒå¯Ÿéƒ¨åˆ†ã¯å°‚é–€å®¶ã®è¦–ç‚¹ã«ã‚ˆã‚‹æ¨æ¸¬ã‚’å«ã¿ã¾ã™ãŒã€å…¨ã¦å®Ÿãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦ã„ã¾ã™ã€‚';
            } else if (result.type === 'SEOæˆ¦ç•¥') {
                explanation = '\n\nğŸ” SEOåˆ†æã®æ ¹æ‹ ï¼š\nâ€¢ æ¤œç´¢ãƒœãƒªãƒ¥ãƒ¼ãƒ ã¯ä¸€èˆ¬çš„ãªSEOãƒ„ãƒ¼ãƒ«ã®æ¨å®šå€¤\nâ€¢ ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã¯å®Ÿéš›ã®ã‚µã‚¤ãƒˆã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‹ã‚‰æŠ½å‡º\nâ€¢ æœŸå¾…åŠ¹æœã¯æ¥­ç•Œæ¨™æº–ã®æŒ‡æ¨™ã«åŸºã¥ãæ¨æ¸¬';
            } else if (result.type === 'ç«¶åˆçŠ¶æ³åˆ†æ') {
                explanation = '\n\nâš”ï¸ ç«¶åˆåˆ†æã®æ ¹æ‹ ï¼š\nè¤‡æ•°ç¤¾ã®å®Ÿã‚µã‚¤ãƒˆã‚’åŒæ™‚æœŸã«èª¿æŸ»ã—ã€ä»¥ä¸‹ã‚’æ¯”è¼ƒï¼š\nâ€¢ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°ã®é•ã„\nâ€¢ ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå±¤ã®é•ã„\nâ€¢ è¨´æ±‚ãƒã‚¤ãƒ³ãƒˆã®é•ã„';
            }

            return explanation;
        }

        function factCheck(result) {
            // ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯æƒ…å ±ã‚’è¿½åŠ 
            let factCheckInfo = '\n\nâœ… ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯ï¼š\n';

            // è¨¼æ‹ ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆ
            const company = companies.find(c => c.name === result.company);
            if (company && company.evidenceSources) {
                factCheckInfo += `â€¢ ãƒ‡ãƒ¼ã‚¿å–å¾—æ—¥: ${company.evidenceSources.retrievalDate}\n`;
                factCheckInfo += `â€¢ å–å¾—å…ƒURL: ${company.evidenceSources.sourceUrl}\n`;
                factCheckInfo += `â€¢ æ¤œè¨¼å¯èƒ½: ã¯ã„ï¼ˆä¸Šè¨˜URLã§ç¢ºèªå¯èƒ½ï¼‰`;
            } else {
                factCheckInfo += 'â€¢ ã“ã®ãƒ‡ãƒ¼ã‚¿ã¯æ¨æ¸¬ã‚’å«ã‚€åˆ†ææƒ…å ±ã§ã™\n';
                factCheckInfo += 'â€¢ å®Ÿãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦ã„ã¾ã™ãŒã€è§£é‡ˆãŒå«ã¾ã‚Œã¾ã™';
            }

            return factCheckInfo;
        }

        async function sendChatMessage(question) {
            const messagesContainer = document.getElementById('chatMessages');

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            const userMsg = document.createElement('div');
            userMsg.className = 'chat-message user';
            userMsg.textContent = question;
            messagesContainer.appendChild(userMsg);

            // ã€Œæ¤œç´¢ä¸­ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'chat-message bot';
            loadingMsg.textContent = 'ğŸ” æƒ…å ±ã‚’æ¤œç´¢ã—ã¦ã„ã¾ã™...';
            messagesContainer.appendChild(loadingMsg);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰æƒ…å ±ã‚’æ¤œç´¢
            const searchResults = searchInData(question);

            // ã€Œæ¤œç´¢ä¸­ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
            messagesContainer.removeChild(loadingMsg);

            // å›ç­”ã‚’ç”Ÿæˆ
            let answer = '';

            if (searchResults.length > 0) {
                // çµæœã‚’æ•´å½¢ã—ã¦è¡¨ç¤ºï¼ˆæœ€å¤§3ä»¶ï¼‰
                const limitedResults = searchResults.slice(0, 3);
                answer = limitedResults.map((result, index) => {
                    let text = `ã€${result.company}ã€‘${result.type}`;
                    if (result.category) text += ` (${result.category})`;
                    text += `\n\n${result.content}`;

                    // è¿½åŠ èª¬æ˜ãŒã‚ã‚‹å ´åˆ
                    if (result.explanation) {
                        text += `\n\n${result.explanation}`;
                    }

                    // ãƒ‡ãƒ¼ã‚¿ã®å‡ºæ‰€ã¨æ ¹æ‹ ã‚’è¿½åŠ 
                    text += explainDataSource(result);

                    // ãƒ•ã‚¡ã‚¯ãƒˆãƒã‚§ãƒƒã‚¯æƒ…å ±ã‚’è¿½åŠ 
                    text += factCheck(result);

                    return text;
                }).join('\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n');

                if (searchResults.length > 3) {
                    answer += `\n\nğŸ“Œ ä»–ã«${searchResults.length - 3}ä»¶ã®é–¢é€£æƒ…å ±ãŒã‚ã‚Šã¾ã™ã€‚`;
                }
            } else {
                // ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€Webæ¤œç´¢ã‚’æ¡ˆå†…
                const webSearchResult = await performWebSearch(question);
                answer = `ğŸ’¡ ã“ã®ã‚·ã‚¹ãƒ†ãƒ å†…ã«ã¯ã€Œ${question}ã€ã«é–¢ã™ã‚‹æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n\n${webSearchResult}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nğŸ“š ã“ã®ã‚·ã‚¹ãƒ†ãƒ ã§å¯¾å¿œã§ãã‚‹è³ªå•ï¼š\nâ€¢ ç‰¹å®šä¼æ¥­ã®æˆ¦ç•¥ãƒ»ãƒã‚¸ã‚·ãƒ§ãƒ‹ãƒ³ã‚°\nâ€¢ ãƒ‡ãƒ¼ã‚¿ã®ä¿¡é ¼æ€§ã‚„å–å¾—æ–¹æ³•\nâ€¢ ç«¶åˆä»–ç¤¾ã¨ã®æ¯”è¼ƒåˆ†æ\nâ€¢ SEOæˆ¦ç•¥ãƒ»ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æˆ¦ç•¥\nâ€¢ åˆ†æãƒ»è€ƒå¯Ÿã®æ ¹æ‹ ã‚„ç†ç”±\nâ€¢ è¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã®å‡ºæ‰€\nâ€¢ ãªãœãã®ãƒ‡ãƒ¼ã‚¿ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã®ã‹\nâ€¢ ãªãœãã®è¡¨ç¾ã‚’ä½¿ã£ã¦ã„ã‚‹ã®ã‹\n\nä¾‹: ã€Œã‚«ã‚ªãƒŠãƒ“ã®æˆ¦ç•¥ã«ã¤ã„ã¦æ•™ãˆã¦ã€ã€Œãªãœãã®åˆ†æçµæœã«ãªã£ãŸã®ã‹ï¼Ÿã€ã€Œãƒ‡ãƒ¼ã‚¿ã®å‡ºæ‰€ã¯ï¼Ÿã€`;
            }

            // ãƒœãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºï¼ˆHTMLãƒªãƒ³ã‚¯å¯¾å¿œï¼‰
            const botMsg = document.createElement('div');
            botMsg.className = 'chat-message bot';
            botMsg.style.whiteSpace = 'pre-wrap';

            // URLã‚’ãƒªãƒ³ã‚¯ã«å¤‰æ›
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const htmlAnswer = answer.replace(urlRegex, '<a href="$1" target="_blank" style="color: #2563eb; text-decoration: underline;">$1</a>');
            botMsg.innerHTML = htmlAnswer;

            messagesContainer.appendChild(botMsg);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢
            document.getElementById('chatInput').value = '';
        }

        function handleChatKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                const input = document.getElementById('chatInput');
                if (input.value.trim()) {
                    sendChatMessage(input.value.trim());
                }
            }
        }
    </script>
</body>
</html>